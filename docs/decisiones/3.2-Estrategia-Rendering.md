# 3.2 - ¿Que estrategia de rendering usar?

## Contexto

**Posicion en arbol:** NIVEL 3.2 - Frontend
**Depende de:** 3.1 (Astro como framework), 1.1 (Hibrido: estaticas + blog CMS)
**Afecta a:** Performance, TTFB, build time, experiencia editor, costos

**Requisitos Qamarero:**
- PageSpeed 95+ para paginas corporativas
- PageSpeed 90+ para blog
- TTFB <100ms para cache hit
- Tiempo publicacion blog <1 min (desde que editor publica)
- Build time <5 min

**Por que es importante:**
- Define como se genera el HTML (build vs request)
- Impacta directamente performance y SEO
- Determina experiencia del editor (tiempo hasta visible)
- Afecta costos de build/hosting

---

## Conceptos Clave

### SSG (Static Site Generation)

```
Build time:
├── Genera HTML para TODAS las paginas
├── Output: archivos .html estaticos
├── Deploy: Solo subir archivos
└── Request: Servir archivo (0 procesamiento)

Flujo:
npm run build → HTML generado → Deploy → Usuario pide pagina → CDN sirve HTML

TTFB: ~0ms (archivo estatico)
```

### SSR (Server-Side Rendering)

```
Request time:
├── Usuario pide pagina
├── Servidor ejecuta codigo
├── Genera HTML dinamicamente
└── Envia HTML al usuario

Flujo:
Usuario pide pagina → Servidor procesa → Genera HTML → Envia

TTFB: ~200-500ms (procesamiento servidor)
```

### ISR (Incremental Static Regeneration)

```
Hibrido:
├── Primera visita: SSR (genera y cachea)
├── Visitas siguientes: Sirve cache (como SSG)
├── Revalidacion: On-demand o time-based
└── Mejor de ambos mundos

Flujo:
Usuario pide pagina
    ↓
¿Existe en cache?
    ├── Si → Servir cache (TTFB ~0ms)
    └── No → SSR + cachear (TTFB ~200ms)

Webhook cambia contenido → Purga cache → Siguiente visita regenera
```

---

## Opciones

### Opcion A: SSG Puro (Todo en build time)

**Como funciona:**
```
npm run build:
├── Fetch TODOS los posts de WordPress
├── Genera HTML para cada post
├── Genera HTML para cada pagina
└── Output: dist/ con todos los .html

Build time para Qamarero:
├── 10 paginas corporativas: ~10 seg
├── 720 posts blog: ~15-20 min (!)
└── Total: ~20 min por build
```

#### Contras para Qamarero

**1. Build time prohibitivo**
```
720 posts actuales:
├── Build time: ~15-20 min
├── 1 post nuevo/dia = rebuild completo
├── 5 posts/dia = 5 rebuilds = 1.5-2 horas/dia
└── Escala MAL ❌

A 1,000 posts:
├── Build time: ~25-30 min
└── Insostenible ❌
```

**2. Latencia de publicacion**
```
Editor publica post:
    ↓
Trigger build (webhook)
    ↓
Build completo: 15-20 min
    ↓
Deploy: 1-2 min
    ↓
Post visible: ~20 min despues ❌

Target Qamarero: <1 min
```

#### Cuando usar SSG puro

```
✅ Sitios pequenos (<100 paginas)
✅ Contenido cambia poco (<1x/semana)
✅ No importa latencia de publicacion
❌ NO aplica a Qamarero (720+ posts, 1+/dia)
```

---

### Opcion B: SSR Puro (Todo en request time)

**Como funciona:**
```
Usuario pide /blog/post-slug:
    ↓
Servidor ejecuta codigo
    ↓
Fetch WordPress (GraphQL)
    ↓
Genera HTML
    ↓
Envia al usuario

Build time: ~30 seg (solo codigo, no contenido)
Request time: ~200-500ms (procesamiento)
```

#### Contras para Qamarero

**1. TTFB alto**
```
Cada request:
├── Fetch WordPress: ~100-200ms
├── Procesar: ~50ms
├── Render: ~50ms
└── TTFB total: ~200-400ms

vs SSG/ISR cache:
└── TTFB: <50ms

Impacto PageSpeed: -5 a -15 puntos ❌
```

**2. Costos servidor**
```
50,000 visitas/mes:
├── 50,000 ejecuciones servidor
├── 50,000 queries WordPress
└── Costo Vercel: Puede exceder free tier

vs ISR:
├── ~500 ejecuciones (cache misses)
└── 99% servido desde cache ✅
```

#### Cuando usar SSR puro

```
✅ Contenido personalizado por usuario
✅ Datos tiempo real (precios, stocks)
✅ Auth requerido para ver contenido
❌ NO aplica a Qamarero (contenido publico, cacheable)
```

---

### Opcion C: ISR (Incremental Static Regeneration)

**Como funciona:**
```
Primera visita a /blog/new-post:
    ↓
No existe en cache
    ↓
SSR: Fetch WordPress + Render HTML
    ↓
Guardar en cache (edge CDN)
    ↓
Enviar al usuario (TTFB ~300ms)

Segunda visita (y siguientes):
    ↓
Existe en cache
    ↓
Servir desde CDN (TTFB <50ms)

Cuando editor publica:
    ↓
Webhook a /api/revalidate
    ↓
Purga cache de esa pagina
    ↓
Siguiente visita regenera
```

#### Pros

**1. TTFB optimo**
```
Cache hit (99% requests):
├── TTFB: <50ms
├── PageSpeed: 95-100
└── Servido desde edge CDN ✅

Cache miss (1% requests):
├── TTFB: ~300ms (aceptable)
├── PageSpeed: 90-95
└── Regenera y cachea ✅
```

**2. Build time minimo**
```
npm run build:
├── Solo paginas corporativas (SSG)
├── Blog: Solo estructura (ISR runtime)
└── Total: ~1-2 min ✅

vs SSG puro:
└── 15-20 min para 720 posts
```

**3. Latencia publicacion <1 min**
```
Editor publica post:
    ↓
Webhook dispara (~2 seg)
    ↓
Cache purga (~1 seg)
    ↓
Siguiente visita regenera (~300ms)
    ↓
Post visible: <1 min ✅
```

**4. Resiliencia**
```
WordPress caido:
├── Cache sigue funcionando
├── Usuarios ven contenido cacheado
├── Solo nuevas paginas fallan
└── Graceful degradation ✅
```

#### Cuando usar ISR

```
✅ Blog con muchos posts (100+)
✅ Publicacion frecuente (1+/dia)
✅ Latencia <1 min requerida
✅ ESTE ES NUESTRO CASO (Qamarero) ✅
```

---

### Opcion D: Hibrido (SSG + ISR)

**Nuestra propuesta:**
```
Contenido corporativo (SSG):
├── Home, Features, Pricing, Legal
├── Generado en build time
├── TTFB: ~0ms (siempre)
├── PageSpeed: 95-100
└── Cambia <1x/mes

Contenido blog (ISR):
├── Posts, categorias, tags
├── Generado on-demand + cache
├── TTFB: <50ms (cache), ~300ms (miss)
├── PageSpeed: 90-95
└── Cambia 1+/dia
```

**Configuracion Astro:**
```astro
---
// src/pages/features.astro
// DEFAULT: prerender = true (SSG)
---
<h1>Features</h1>
<!-- Generado en build time -->
```

```astro
---
// src/pages/blog/[slug].astro
export const prerender = false; // ISR
---
<h1>{post.title}</h1>
<!-- Generado on-demand -->
```

```javascript
// astro.config.mjs
export default defineConfig({
  output: 'hybrid', // Permite mezclar SSG + SSR/ISR
  adapter: vercel({
    isr: true, // Habilita ISR en Vercel
  }),
});
```

---

## Comparacion Final

| Criterio | SSG Puro | SSR Puro | ISR | Hibrido |
|----------|----------|----------|-----|---------|
| **Build time** | 15-20 min | ~30 seg | ~1-2 min | ~1-2 min |
| **TTFB cache** | ~0ms | N/A | <50ms | <50ms |
| **TTFB miss** | N/A | ~300ms | ~300ms | ~300ms |
| **Latencia pub** | ~20 min | ~0 seg | <1 min | <1 min |
| **PageSpeed** | 95-100 | 85-95 | 90-100 | 90-100 |
| **Resiliencia** | Alta | Baja | Alta | Alta |
| **Complejidad** | Baja | Baja | Media | Media |
| **Para Qamarero** | ❌ | ❌ | ✅ | ✅ IDEAL |

---

## Propuesta: Hibrido (SSG + ISR)

### Por que para Qamarero

**1. Dos tipos de contenido = dos estrategias**
```
Corporativo:
├── Cambia raramente (<1x/mes)
├── Requiere 100% performance
├── Controlado por equipo tecnico
└── → SSG (build time) ✅

Blog:
├── Cambia frecuentemente (1+/dia)
├── Requiere latencia <1 min
├── Controlado por marketing
└── → ISR (on-demand) ✅
```

**2. Metricas objetivo cumplidas**
```
Build time:
├── Target: <5 min
├── Hibrido: ~1-2 min ✅

TTFB (cache):
├── Target: <100ms
├── Hibrido: <50ms ✅

Latencia publicacion:
├── Target: <1 min
├── Hibrido: <1 min ✅

PageSpeed corporativo:
├── Target: 95+
├── SSG: 95-100 ✅

PageSpeed blog:
├── Target: 90+
├── ISR: 90-95 ✅
```

**3. Escalabilidad**
```
Hoy: 720 posts
├── SSG puro: 15-20 min build ❌
├── Hibrido: ~1-2 min build ✅

A 2,000 posts:
├── SSG puro: ~45-60 min build ❌
├── Hibrido: ~1-2 min build (mismo) ✅

ISR escala infinitamente
```

---

## Trade-offs Aceptados

| Trade-off | Aceptado porque... |
|-----------|---------------------|
| Primera visita ISR mas lenta (~300ms) | Ocurre <1% requests, cache se llena rapido |
| Complejidad webhook | Beneficio (latencia <1 min) supera costo |
| Dependencia Vercel ISR | Vercel es hosting elegido, ISR nativo |

---

## Criterios Go/No-Go

### Criterios de Exito

- [ ] **SSG corporativo:** PageSpeed 95+
- [ ] **SSG corporativo:** TTFB <50ms
- [ ] **ISR blog:** Cache hit TTFB <100ms
- [ ] **ISR blog:** PageSpeed 90+
- [ ] **Revalidation:** Funciona con webhook
- [ ] **Build time:** <2 min
- [ ] **Latencia publicacion:** <60 seg

### Decision Gate

```
TODOS criterios OK?
│
├── Si → APROBAR estrategia hibrida SSG + ISR
│         └── Pasar a 3.3 (Hosting frontend)
│
└── No → ITERAR sobre problema especifico
          ├── PageSpeed bajo: Optimizar assets/queries
          ├── TTFB alto: Revisar cache config
          ├── Build lento: Verificar que blog es ISR
          └── Revalidation falla: Debuggear webhook
```

---

## Referencias

- **Astro Output Modes:** https://docs.astro.build/en/basics/rendering-modes/
- **Vercel ISR:** https://vercel.com/docs/incremental-static-regeneration
- **Astro + Vercel ISR:** https://docs.astro.build/en/guides/integrations-guide/vercel/
- **3.1:** [3.1-Framework-Frontend.md](./3.1-Framework-Frontend.md)

---

**Preparado por:** Miguel Ortiz Peralta
**Fecha:** 3 Febrero 2026
**Version:** 1.0
**Estado:** Pendiente de validar en POC
