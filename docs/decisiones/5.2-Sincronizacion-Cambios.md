# 5.2 - Â¿CÃ³mo sincronizar cambios del CMS?

## ğŸ“‹ Contexto

**PosiciÃ³n en Ã¡rbol:** NIVEL 5.2 - IntegraciÃ³n TÃ©cnica
**Depende de:** 5.1 (IntegraciÃ³n WP-Astro), 1.2 (WordPress como CMS)
**Afecta a:** Tiempo hasta visible, experiencia editor, confiabilidad

**Requisitos Qamarero:**
- Tiempo hasta visible: <1 min (desde que editor publica)
- Confiabilidad webhook: 100% (no puede fallar silenciosamente)
- Seguridad: Endpoint protegido (no pÃºblico)
- Monitoreo: Saber si algo falla (alertas)

**Por quÃ© es importante:**
- Define velocidad de publicaciÃ³n (crÃ­tico para blog activo)
- Impacta experiencia del editor (publicar â†’ ver cambio)
- Afecta confiabilidad del sistema (Â¿y si falla?)

---

## ğŸ¯ DecisiÃ³n

**Pregunta fundamental:**
**"Cuando un editor publica en WordPress, Â¿cÃ³mo actualizamos el frontend instantÃ¡neamente?"**

**6 sub-decisiones:**
1. Trigger de sincronizaciÃ³n
2. Endpoint de revalidation
3. Seguridad del webhook
4. QuÃ© revalidar (selectivo vs todo)
5. Fallback si falla
6. Logging y monitoreo

---

## âš–ï¸ Opciones

### DecisiÃ³n 5.2.1: Trigger de SincronizaciÃ³n

#### OpciÃ³n A: WordPress Webhook â­

**CÃ³mo funciona:**
```
Editor publica post en WordPress
    â†“
WordPress hook: publish_post, save_post
    â†“
Plugin dispara webhook a URL externa
    â†“
POST https://qamarero.com/api/revalidate
    â†“
Vercel purga cache de pÃ¡gina especÃ­fica
    â†“
Siguiente visita regenera HTML
```

**Plugins disponibles:**
```
WP Webhooks (Gratis):
â”œâ”€ Configura URL destino
â”œâ”€ Selecciona eventos (publish_post, update_post)
â”œâ”€ Payload customizable
â””â”€ Logs de webhooks enviados

Alternativa: Custom code (functions.php):
â”œâ”€ Hook directo a WordPress actions
â””â”€ Control total sobre payload
```

**Pros:**
- âœ… InstantÃ¡neo (dispara cuando editor publica)
- âœ… Eficiente (solo cuando hay cambios)
- âœ… Selectivo (sabe quÃ© post cambiÃ³)
- âœ… EstÃ¡ndar industria (patrÃ³n comÃºn)

**Contras:**
- âš ï¸ Requiere configuraciÃ³n plugin/cÃ³digo
- âš ï¸ Puede fallar si Vercel estÃ¡ down

**CuÃ¡ndo usar:**
```
âœ… ActualizaciÃ³n instantÃ¡nea necesaria (<1 min)
âœ… PublicaciÃ³n frecuente (1+/dÃ­a)
âœ… ISR habilitado (on-demand revalidation)
âœ… Este es nuestro caso (Qamarero) âœ…
```

---

#### OpciÃ³n B: Polling (Verificar cada X minutos)

**CÃ³mo funciona:**
```
Cada 5 minutos:
â”œâ”€ Cron job verifica WordPress API
â”œâ”€ Compara timestamps de posts
â”œâ”€ Si hay cambios â†’ rebuild/revalidate
â””â”€ Si no hay cambios â†’ nada
```

**Contras:**
- âŒ No instantÃ¡neo (delay de hasta 5 min)
- âŒ Ineficiente (verifica aunque no haya cambios)
- âŒ MÃ¡s complejo (requiere cron job + lÃ³gica diff)

**CuÃ¡ndo usar:**
```
âœ… Webhook no es posible (firewall, restricciones)
âœ… Delay aceptable (>5 min OK)
âŒ NO recomendado para Qamarero (necesita <1 min)
```

---

#### OpciÃ³n C: Rebuild Completo (Cada cambio)

**CÃ³mo funciona:**
```
Editor publica post
    â†“
Webhook dispara Vercel rebuild completo
    â†“
Regenera TODAS las pÃ¡ginas (~720 posts)
    â†“
Build time: ~20-30 min
```

**Contras:**
- âŒ Muy lento (20-30 min por cambio)
- âŒ Ineficiente (regenera todo aunque solo cambiÃ³ 1 post)
- âŒ Costoso (consume build minutes de Vercel)

**CuÃ¡ndo usar:**
```
âœ… Pocos posts (<50) y publicaciÃ³n infrecuente
âŒ NO recomendado para Qamarero (720+ posts, 1+/dÃ­a)
```

---

### DecisiÃ³n 5.2.2: Endpoint de Revalidation

#### OpciÃ³n A: Vercel On-Demand Revalidation â­

**CÃ³mo funciona:**
```typescript
// src/pages/api/revalidate.ts
export const prerender = false;

export async function POST({ request }) {
  const body = await request.json();
  const secret = request.headers.get('x-webhook-secret');

  // 1. Validar secret
  if (secret !== import.meta.env.REVALIDATE_SECRET) {
    return new Response('Unauthorized', { status: 401 });
  }

  // 2. Extraer paths a revalidar
  const { post_type, post_name, lang } = body;
  const paths = buildPathsToRevalidate(post_type, post_name, lang);

  // 3. Llamar Vercel API para purgar cache
  for (const path of paths) {
    await fetch(`https://api.vercel.com/v1/projects/${PROJECT_ID}/revalidate?path=${path}`, {
      method: 'POST',
      headers: {
        Authorization: `Bearer ${VERCEL_TOKEN}`,
      },
    });
  }

  return new Response(JSON.stringify({ revalidated: paths }), {
    status: 200,
    headers: { 'Content-Type': 'application/json' },
  });
}
```

**FunciÃ³n para construir paths:**
```typescript
function buildPathsToRevalidate(post_type: string, slug: string, lang: string) {
  const paths = [];

  if (post_type === 'post') {
    // Revalidar pÃ¡gina del post
    if (lang === 'es') {
      paths.push(`/blog/${slug}`);
    } else {
      paths.push(`/${lang}/blog/${slug}`);
    }

    // Revalidar lista del blog (tiene nuevo post)
    paths.push(lang === 'es' ? '/blog' : `/${lang}/blog`);
  }

  return paths;
}
```

**Pros:**
- âœ… Selectivo (solo purga pÃ¡ginas afectadas)
- âœ… RÃ¡pido (<1 seg para purgar)
- âœ… Eficiente (no rebuild completo)
- âœ… Nativo Vercel (bien integrado con ISR)

**Contras:**
- âš ï¸ Requiere Vercel API token
- âš ï¸ Requiere lÃ³gica para mapear post â†’ paths

**CuÃ¡ndo usar:**
```
âœ… ISR habilitado
âœ… Vercel como hosting
âœ… Necesita actualizaciÃ³n selectiva
âœ… Este es nuestro caso (Qamarero) âœ…
```

---

#### OpciÃ³n B: Tag-based Revalidation

**CÃ³mo funciona:**
```typescript
// En pÃ¡gina blog
export const config = {
  revalidateTags: ['blog-posts'],
};

// En endpoint revalidate
await fetch('/api/revalidate?tag=blog-posts');
// Purga TODAS las pÃ¡ginas con ese tag
```

**Contras:**
- âš ï¸ Menos selectivo (purga muchas pÃ¡ginas a la vez)
- âš ï¸ MÃ¡s lento que path-based

**CuÃ¡ndo usar:**
```
âœ… Muchas pÃ¡ginas dependen del mismo dato
âš ï¸ Aceptable para Qamarero (alternativa vÃ¡lida)
```

---

### DecisiÃ³n 5.2.3: Seguridad del Webhook

#### OpciÃ³n A: Secret Token Validation â­

**CÃ³mo funciona:**
```
WordPress:
â”œâ”€ Configura header: x-webhook-secret = [SECRET]
â””â”€ EnvÃ­a con cada webhook

Vercel endpoint:
â”œâ”€ Lee header x-webhook-secret
â”œâ”€ Compara con REVALIDATE_SECRET env var
â”œâ”€ Si no coincide â†’ 401 Unauthorized
â””â”€ Si coincide â†’ procesa request
```

**CÃ³digo validaciÃ³n:**
```typescript
export async function POST({ request }) {
  const secret = request.headers.get('x-webhook-secret');

  if (!secret || secret !== import.meta.env.REVALIDATE_SECRET) {
    console.error('Invalid webhook secret');
    return new Response('Unauthorized', { status: 401 });
  }

  // Procesar webhook...
}
```

**Variables de entorno:**
```
# Vercel Dashboard â†’ Project â†’ Settings â†’ Environment Variables
REVALIDATE_SECRET=tu-secret-super-seguro-aqui-123

# WordPress plugin config
Webhook URL: https://qamarero.com/api/revalidate
Header: x-webhook-secret = tu-secret-super-seguro-aqui-123
```

**Pros:**
- âœ… Simple de implementar
- âœ… EstÃ¡ndar industria (patrÃ³n comÃºn)
- âœ… Seguro (solo quien conoce secret puede disparar)

**Contras:**
- âš ï¸ Secret debe mantenerse privado

**CuÃ¡ndo usar:**
```
âœ… Siempre (best practice)
âœ… Este es nuestro caso (Qamarero) âœ…
```

---

#### OpciÃ³n B: IP Whitelist

**CÃ³mo funciona:**
```
Vercel endpoint:
â”œâ”€ Lee IP de origen
â”œâ”€ Compara con whitelist de IPs (Cloudways)
â”œâ”€ Si no estÃ¡ en lista â†’ 403 Forbidden
â””â”€ Si estÃ¡ â†’ procesa request
```

**Contras:**
- âŒ IPs de Cloudways pueden cambiar
- âŒ MÃ¡s complejo de mantener
- âŒ No funciona si Cloudways usa CDN

**CuÃ¡ndo usar:**
```
âœ… Seguridad adicional a secret token
âŒ NO recomendado como Ãºnica medida
```

---

### DecisiÃ³n 5.2.4: QuÃ© Revalidar

#### OpciÃ³n A: Solo PÃ¡gina Modificada â­

**CÃ³mo funciona:**
```
Post "5-ideas-menu" publicado:
    â†“
Webhook incluye: { slug: "5-ideas-menu", lang: "es" }
    â†“
Endpoint calcula paths:
â”œâ”€ /blog/5-ideas-menu (pÃ¡gina del post)
â””â”€ /blog (lista, tiene nuevo post)
    â†“
Purga solo esos 2 paths
    â†“
Resto del sitio NO afectado âœ…
```

**Pros:**
- âœ… Eficiente (solo purga lo necesario)
- âœ… RÃ¡pido (2 paths vs 720+)
- âœ… No afecta pÃ¡ginas no relacionadas

**Contras:**
- âš ï¸ Requiere lÃ³gica para mapear post â†’ paths
- âš ï¸ Puede olvidar purgar pÃ¡gina relacionada

**CuÃ¡ndo usar:**
```
âœ… Muchas pÃ¡ginas (720+ posts)
âœ… Performance crÃ­tico
âœ… Este es nuestro caso (Qamarero) âœ…
```

---

#### OpciÃ³n B: Purgar Todo el Sitio

**CÃ³mo funciona:**
```
Cualquier cambio en WordPress
    â†“
Purga cache de TODO el sitio
    â†“
Siguiente visita a cualquier pÃ¡gina = regenera
```

**Contras:**
- âŒ Ineficiente (purga pÃ¡ginas no afectadas)
- âŒ Aumenta carga en servidor (regenera todo)
- âŒ TTFB alto temporalmente (cache vacÃ­o)

**CuÃ¡ndo usar:**
```
âœ… Sitio muy pequeÃ±o (<50 pÃ¡ginas)
âœ… Cambios afectan muchas pÃ¡ginas (footer, nav)
âŒ NO recomendado para Qamarero (720+ posts)
```

---

### DecisiÃ³n 5.2.5: Fallback si Webhook Falla

#### OpciÃ³n A: Manual Rebuild + Alertas â­

**Estrategia:**
```
Webhook falla:
â”œâ”€ Log error en Vercel
â”œâ”€ Alerta a Slack/email
â””â”€ Editor puede:
    â”œâ”€ Esperar fix automÃ¡tico (retry)
    â””â”€ Disparar rebuild manual desde Vercel dashboard

Rebuild manual:
â”œâ”€ Vercel Dashboard â†’ Deployments â†’ Redeploy
â””â”€ Regenera TODO el sitio (~2-5 min)
```

**ImplementaciÃ³n alertas:**
```typescript
// En endpoint revalidate
try {
  await revalidatePaths(paths);
  return new Response('OK', { status: 200 });
} catch (error) {
  // Log error
  console.error('Revalidation failed:', error);

  // Enviar alerta a Slack
  await fetch(SLACK_WEBHOOK_URL, {
    method: 'POST',
    body: JSON.stringify({
      text: `âš ï¸ Revalidation failed for paths: ${paths.join(', ')}`,
    }),
  });

  return new Response('Revalidation failed', { status: 500 });
}
```

**Pros:**
- âœ… Siempre hay fallback (rebuild manual)
- âœ… Alertas evitan fallos silenciosos
- âœ… Simple de implementar

**Contras:**
- âš ï¸ Rebuild manual toma mÃ¡s tiempo (~2-5 min)
- âš ï¸ Requiere intervenciÃ³n humana

**CuÃ¡ndo usar:**
```
âœ… Siempre (best practice)
âœ… Este es nuestro caso (Qamarero) âœ…
```

---

#### OpciÃ³n B: Auto-Retry

**CÃ³mo funciona:**
```
Webhook falla:
â”œâ”€ Retry 1: Esperar 5 seg, reintentar
â”œâ”€ Retry 2: Esperar 30 seg, reintentar
â”œâ”€ Retry 3: Esperar 2 min, reintentar
â””â”€ Si todos fallan â†’ fallback manual + alerta
```

**Pros:**
- âœ… Resuelve fallos temporales automÃ¡ticamente
- âœ… Sin intervenciÃ³n humana para errores transitorios

**Contras:**
- âš ï¸ MÃ¡s complejo de implementar
- âš ï¸ Puede retrasar detecciÃ³n de errores reales

**CuÃ¡ndo usar:**
```
âœ… Errores transitorios frecuentes (red inestable)
âš ï¸ Considerar para Qamarero (nice to have)
```

---

### DecisiÃ³n 5.2.6: Logging y Monitoreo

#### OpciÃ³n A: Vercel Logs + Slack Alertas â­

**Arquitectura:**
```
Vercel Logs:
â”œâ”€ Todos los requests a /api/revalidate
â”œâ”€ Errores y excepciones
â”œâ”€ Tiempo de respuesta
â””â”€ RetenciÃ³n: 30 dÃ­as (plan free)

Slack Alertas:
â”œâ”€ Webhook falla â†’ mensaje inmediato
â”œâ”€ MÃºltiples fallos â†’ mensaje urgente
â””â”€ Canal: #qamarero-alerts

Dashboard opcional:
â”œâ”€ Vercel Analytics (incluido)
â””â”€ MÃ©tricas: Ã©xito/fallo, latencia
```

**ImplementaciÃ³n logging:**
```typescript
export async function POST({ request }) {
  const startTime = Date.now();
  const requestId = crypto.randomUUID();

  console.log(`[${requestId}] Revalidation started`);

  try {
    const body = await request.json();
    console.log(`[${requestId}] Payload:`, JSON.stringify(body));

    const paths = await revalidatePaths(body);

    const duration = Date.now() - startTime;
    console.log(`[${requestId}] Success in ${duration}ms. Paths: ${paths.join(', ')}`);

    return new Response(JSON.stringify({
      success: true,
      requestId,
      paths,
      duration,
    }), { status: 200 });

  } catch (error) {
    const duration = Date.now() - startTime;
    console.error(`[${requestId}] Failed in ${duration}ms:`, error);

    // Alerta Slack
    await sendSlackAlert(requestId, error);

    return new Response(JSON.stringify({
      success: false,
      requestId,
      error: error.message,
    }), { status: 500 });
  }
}
```

**Pros:**
- âœ… Visibilidad completa (logs detallados)
- âœ… Alertas proactivas (no esperar quejas)
- âœ… Debug fÃ¡cil (requestId para trazar)

**Contras:**
- âš ï¸ Requiere setup Slack webhook
- âš ï¸ Logs tienen retenciÃ³n limitada

**CuÃ¡ndo usar:**
```
âœ… Siempre (best practice)
âœ… Este es nuestro caso (Qamarero) âœ…
```

---

## ğŸ“Š ComparaciÃ³n Final

| DecisiÃ³n | OpciÃ³n Elegida | Alternativa | Por quÃ© |
|----------|----------------|-------------|---------|
| **5.2.1 Trigger** | WordPress Webhook â­ | Polling | InstantÃ¡neo, eficiente |
| **5.2.2 Endpoint** | Vercel On-Demand â­ | Tag-based | Selectivo, rÃ¡pido |
| **5.2.3 Seguridad** | Secret Token â­ | IP Whitelist | Simple, estÃ¡ndar |
| **5.2.4 QuÃ© revalidar** | Solo modificado â­ | Todo el sitio | Eficiente, 720+ posts |
| **5.2.5 Fallback** | Manual + Alertas â­ | Auto-retry | Simple, siempre funciona |
| **5.2.6 Logging** | Vercel + Slack â­ | Solo logs | Proactivo, visible |

---

## ğŸ’¡ Propuesta: SincronizaciÃ³n Completa

### Arquitectura

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ WORDPRESS (Cloudways)                               â”‚
â”‚                                                     â”‚
â”‚ Editor publica post                                 â”‚
â”‚     â†“                                               â”‚
â”‚ Hook: publish_post, save_post                       â”‚
â”‚     â†“                                               â”‚
â”‚ Plugin WP Webhooks dispara:                         â”‚
â”‚ POST https://qamarero.com/api/revalidate           â”‚
â”‚ Headers: x-webhook-secret = [SECRET]                â”‚
â”‚ Body: { post_type, slug, lang, action }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VERCEL ENDPOINT (/api/revalidate)                   â”‚
â”‚                                                     â”‚
â”‚ 1. Validar secret token                             â”‚
â”‚ 2. Extraer post info del payload                    â”‚
â”‚ 3. Calcular paths a revalidar                       â”‚
â”‚ 4. Llamar Vercel API para purgar cache             â”‚
â”‚ 5. Log resultado                                    â”‚
â”‚ 6. Si error â†’ Alerta Slack                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ VERCEL CACHE                                        â”‚
â”‚                                                     â”‚
â”‚ Paths purgados:                                     â”‚
â”‚ â”œâ”€ /blog/5-ideas-menu (pÃ¡gina del post)            â”‚
â”‚ â””â”€ /blog (lista actualizada)                       â”‚
â”‚                                                     â”‚
â”‚ Siguiente visita â†’ regenera HTML (~500ms)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ USUARIO                                             â”‚
â”‚                                                     â”‚
â”‚ Visita /blog/5-ideas-menu                          â”‚
â”‚     â†“                                               â”‚
â”‚ Vercel regenera pÃ¡gina (ISR)                        â”‚
â”‚     â†“                                               â”‚
â”‚ HTML servido (~500ms primera visita)               â”‚
â”‚     â†“                                               â”‚
â”‚ Cache poblado para siguientes visitas (<100ms)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

TIEMPO TOTAL: Editor publica â†’ Usuario ve = <1 min âœ…
```

---

## ğŸ§ª ValidaciÃ³n en POC

### Test 5.2.1: Configurar Webhook WordPress

**Setup:**
```
1. WordPress Admin â†’ Plugins â†’ Add New
2. Buscar: "WP Webhooks"
3. Instalar + Activar
4. Configurar webhook:
   - Name: "Revalidate Vercel"
   - URL: https://qamarero.com/api/revalidate
   - Method: POST
   - Headers: x-webhook-secret = [SECRET]
   - Events: publish_post, save_post
```

**Tests:**
```
Test A: Webhook dispara al publicar
1. Crear post de prueba en WordPress
2. Publicar post
3. Verificar: WP Webhooks log muestra "Sent successfully"
4. Resultado esperado: 200 OK âœ…

Test B: Webhook envÃ­a payload correcto
1. Publicar post
2. Ver payload en logs:
   {
     "post_type": "post",
     "post_name": "test-post",
     "post_status": "publish",
     "site_lang": "es"
   }
3. Resultado esperado: Payload completo âœ…
```

**MÃ©tricas:**
- [ ] Webhook dispara al publicar: 100%
- [ ] Payload contiene info necesaria: 100%

---

### Test 5.2.2: Implementar Endpoint Revalidate

**Setup:**
```typescript
// src/pages/api/revalidate.ts
// Ver cÃ³digo completo en secciÃ³n 3.2.2
```

**Tests:**
```
Test A: Endpoint rechaza sin secret
1. curl -X POST https://qamarero.com/api/revalidate
   (sin header x-webhook-secret)
2. Resultado esperado: 401 Unauthorized âœ…

Test B: Endpoint acepta con secret vÃ¡lido
1. curl -X POST https://qamarero.com/api/revalidate \
   -H "x-webhook-secret: [SECRET]" \
   -H "Content-Type: application/json" \
   -d '{"post_type":"post","post_name":"test","site_lang":"es"}'
2. Resultado esperado: 200 OK âœ…
3. Response: { "success": true, "paths": ["/blog/test", "/blog"] }

Test C: Endpoint purga cache correctamente
1. Publicar post en WordPress
2. Verificar Vercel logs: "Revalidation started"
3. Verificar paths purgados
4. Visitar pÃ¡gina: Regenerada con nuevo contenido âœ…
```

**MÃ©tricas:**
- [ ] Endpoint protegido con secret: 100%
- [ ] Paths calculados correctamente: 100%
- [ ] Cache purgado exitosamente: 100%

---

### Test 5.2.3: Medir Tiempo hasta Visible

**Setup:**
```
1. Preparar cronÃ³metro
2. Tener pÃ¡gina /blog abierta en otra pestaÃ±a
```

**Tests:**
```
Test A: Tiempo total editor â†’ usuario
1. Abrir WordPress admin
2. Crear post nuevo
3. Iniciar cronÃ³metro
4. Click "Publicar"
5. Refresh pÃ¡gina /blog
6. Parar cronÃ³metro cuando post aparece
7. Anotar tiempo: ___ segundos

Resultado esperado: <60 segundos âœ…
```

**MÃ©tricas:**
- [ ] Tiempo hasta visible: <60 seg target
- [ ] Webhook latency: <2 seg
- [ ] Revalidation latency: <5 seg
- [ ] Primera visita regenera: <1 seg

---

### Test 5.2.4: Error Handling y Alertas

**Setup:**
```
1. Configurar Slack webhook
2. AÃ±adir SLACK_WEBHOOK_URL a env vars
```

**Tests:**
```
Test A: Fallo genera alerta
1. Simular fallo en endpoint (throw error)
2. Disparar webhook desde WordPress
3. Verificar: Alerta llega a Slack âœ…
4. Mensaje incluye: paths, error, requestId

Test B: Logs muestran error detallado
1. Simular fallo
2. Ver Vercel logs
3. Verificar: Error logeado con stack trace âœ…

Test C: Fallback manual funciona
1. Simular webhook que falla
2. Ir a Vercel Dashboard â†’ Deployments
3. Click "Redeploy"
4. Verificar: Sitio regenerado correctamente âœ…
```

**MÃ©tricas:**
- [ ] Alertas Slack funcionan: 100%
- [ ] Logs detallados presentes: 100%
- [ ] Fallback manual disponible: 100%

---

### Test 5.2.5: Confiabilidad (Stress Test)

**Setup:**
```
1. Crear 10 posts de prueba
2. Preparar script para publicar en secuencia
```

**Tests:**
```
Test A: MÃºltiples webhooks en secuencia
1. Publicar 10 posts en 5 minutos
2. Verificar: 10/10 webhooks exitosos
3. Verificar: Todos los posts visibles en frontend
4. Resultado esperado: 100% Ã©xito âœ…

Test B: Webhook concurrentes
1. Publicar 3 posts simultÃ¡neamente
2. Verificar: 3/3 webhooks exitosos
3. Sin race conditions o errores
4. Resultado esperado: 100% Ã©xito âœ…
```

**MÃ©tricas:**
- [ ] Confiabilidad webhook: 100% (10/10)
- [ ] Sin errores concurrentes: 100%
- [ ] Todos posts visibles: 100%

---

## âœ… Criterios Go/No-Go

### Criterios de Ã‰xito (TODOS deben cumplirse)

- [ ] **Tiempo hasta visible:** <60 segundos
- [ ] **Webhook confiabilidad:** 100% (10/10 tests)
- [ ] **Endpoint protegido:** Secret validation funciona
- [ ] **Paths correctos:** Revalida solo pÃ¡ginas afectadas
- [ ] **Alertas funcionan:** Slack recibe errores
- [ ] **Fallback disponible:** Manual rebuild funciona
- [ ] **Logs completos:** Trazabilidad con requestId

### DecisiÃ³n Gate

```
TODOS criterios âœ…?
â”‚
â”œâ”€ SÃ­ â†’ âœ… APROBAR sincronizaciÃ³n
â”‚        â””â”€ Sistema listo para producciÃ³n
â”‚
â””â”€ No â†’ âš ï¸ ITERAR sobre problema especÃ­fico
         â”œâ”€ Tiempo >60 seg: Optimizar endpoint
         â”œâ”€ Webhook falla: Revisar config plugin
         â”œâ”€ Alertas no llegan: Verificar Slack webhook
         â””â”€ Paths incorrectos: Ajustar lÃ³gica mapeo
```

---

## ğŸ”„ CuÃ¡ndo Reconsiderar

**Cambiar a polling si:**
- Firewall bloquea webhooks salientes
- WordPress hosting no soporta webhooks

**Cambiar a rebuild completo si:**
- Sitio reduce a <50 pÃ¡ginas
- Cambios siempre afectan muchas pÃ¡ginas

**Por ahora NO aplica:** Webhook + ISR on-demand es la mejor opciÃ³n para 720+ posts con publicaciÃ³n frecuente.

---

## ğŸ“š Referencias

- **Vercel On-Demand ISR:** https://vercel.com/docs/concepts/incremental-static-regeneration
- **WP Webhooks:** https://wordpress.org/plugins/wp-webhooks/
- **5.1:** [5.1-Integracion-WP-Astro.md](./5.1-Integracion-WP-Astro.md) (fetch GraphQL)

---

**Preparado por:** Miguel Ortiz Peralta
**Fecha:** 3 Febrero 2026
**VersiÃ³n:** 1.0
**Estado:** â³ Pendiente de validar en POC
