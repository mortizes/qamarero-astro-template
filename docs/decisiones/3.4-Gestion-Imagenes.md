# 3.4 - ¿Como gestionar imagenes?

## Contexto

**Posicion en arbol:** NIVEL 3.4 - Frontend
**Depende de:** 3.1 (Astro), 3.2 (ISR), 1.2 (WordPress)
**Afecta a:** Performance, build time, costos, experiencia editor

**Requisitos Qamarero:**
- Build time <5 min (con ~1,330 imagenes existentes)
- PageSpeed 95+ (imagenes optimizadas)
- Formatos modernos (WebP, AVIF)
- Lazy loading nativo
- Sincronizacion automatica con WordPress

**Volumen estimado:**
- Imagenes estaticas: ~100 (logos, iconos, heroes)
- Imagenes dinamicas (blog): ~1,200+ (featured images, inline)
- Trafico: 50K-200K visitas/mes

---

## Dos Tipos de Imagenes

| Tipo | Ubicacion | Gestion | Editores | Frecuencia |
|------|-----------|---------|----------|------------|
| **Estaticas** | Repo Git (`src/assets/`) | Figma → export → commit | Equipo tecnico | Poco frecuente |
| **Dinamicas** | WordPress Media Library | WP Admin | Marketing | Muy frecuente |

### Ejemplos

**Estaticas:**
- Home hero image
- Feature screenshots
- Pricing illustrations
- Logos partners
- Iconos UI

**Dinamicas:**
- Featured images del blog
- Imagenes inline en posts
- Casos de exito
- Fotos autores

---

## Opciones

### Opcion A: Astro Nativo (Sharp)

**Como funciona:**
```
Build time:
├── Astro procesa imagenes con Sharp
├── Genera WebP/AVIF automaticamente
├── Crea srcset responsive
├── Cachea en ./node_modules/.astro/
└── Rebuilds: Solo procesa nuevas/modificadas

Resultado:
├── Imagenes optimizadas automaticamente
├── 0 config necesaria
└── $0/mes
```

**Ejemplo estaticas:**
```astro
---
// src/pages/index.astro
import { Image } from 'astro:assets';
import heroImage from '../assets/images/hero.jpg';
---

<Image
  src={heroImage}
  alt="Qamarero Dashboard"
  width={1200}
  height={600}
  format="webp"
  loading="eager"
/>

<!-- Output: WebP optimizado, srcset responsive -->
```

**Ejemplo dinamicas (WordPress):**
```astro
---
// src/pages/blog/[slug].astro
import { Image } from 'astro:assets';
import { getPostBySlug } from '../../lib/wordpress';

const { slug } = Astro.params;
const { post } = await getPostBySlug(slug);
const featuredImage = post.featuredImage?.node;
---

<Image
  src={featuredImage.sourceUrl}
  alt={featuredImage.altText || post.title}
  width={featuredImage.mediaDetails.width}
  height={featuredImage.mediaDetails.height}
  format="webp"
  loading="lazy"
/>
```

**Configuracion:**
```javascript
// astro.config.mjs
export default defineConfig({
  output: 'hybrid',
  adapter: vercel({ isr: true, imageService: true }),
  image: {
    service: { entrypoint: 'astro/assets/services/sharp' },
    remotePatterns: [{
      protocol: 'https',
      hostname: 'poc.qamarero.com',
      pathname: '/wp-content/uploads/**',
    }],
  },
});
```

#### Pros

```
Costo:
└── $0/mes ✅

Simplicidad:
├── Zero-config
├── Funciona out-of-the-box
└── Sin dependencias externas ✅

Optimizaciones automaticas:
├── WebP/AVIF conversion
├── Responsive srcset
├── Lazy loading
└── Quality optimization ✅
```

#### Contras potenciales

```
Build time:
├── Primer build: Procesa TODAS las imagenes (~3-5 min)
├── Rebuilds: Solo nuevas (con cache ~2 min)
└── Riesgo: Si cache se pierde, rebuild completo

Caso real documentado:
├── Blog con 1,200 imagenes
├── Primer build: ~5 min
├── Con cache: ~2 min ✅
└── Aceptable para Qamarero
```

#### Cuando usar Astro nativo

```
✅ Siempre empezar aqui (POC)
✅ Build time <5 min con cache
✅ Presupuesto limitado ($0)
✅ ESTE ES NUESTRO PUNTO DE PARTIDA
```

---

### Opcion B: Cloudflare Images

**Como funciona:**
```
WordPress:
├── Plugin Cloudflare Images
├── Al subir imagen → sube a Cloudflare
├── URL: imagedelivery.net/[account]/[id]/public
└── Sync automatico con Media Library

Astro:
├── Usa URL de Cloudflare directamente
├── NO procesa imagenes en build
├── Build time: ~30 seg (sin imagenes)
└── Transformaciones en CDN (resize, format)
```

#### Pros

```
Build time:
├── ~30 seg (sin procesar imagenes)
└── Escala infinitamente ✅

CDN global:
├── Imagenes servidas desde edge
├── TTFB <50ms
└── Cache automatico ✅
```

#### Contras

```
Costo:
├── Free tier: 5,000 transforms/mes
├── Adicional: $0.50/1,000 transforms
├── Estimado Qamarero: $5-10/mes
└── No es gratis ⚠️

Setup:
├── Requiere cuenta Cloudflare
├── Plugin WordPress
├── Migracion imagenes existentes
└── Mas complejo que Astro nativo ⚠️
```

#### Cuando usar Cloudflare Images

```
✅ Build time >5 min con Astro nativo
✅ Muchas imagenes dinamicas (5,000+)
✅ Presupuesto: $5-10/mes aceptable
⚠️ Solo migrar SI Astro nativo no cumple
```

---

### Opcion C: Cloudinary

**Como funciona:**
```
Similar a Cloudflare pero:
├── Mas features (AI transforms, DAM)
├── Mas caro ($89/mes plan basico)
└── Over-engineering para nuestro caso
```

#### Cuando usar Cloudinary

```
✅ Necesitas AI transforms (auto-crop, background removal)
✅ DAM avanzado (equipos grandes, workflows)
✅ Presupuesto: $89+/mes
❌ NO recomendado para Qamarero (overkill)
```

---

## Comparacion Final

| Criterio | Astro Nativo | Cloudflare | Cloudinary |
|----------|--------------|------------|------------|
| **Costo/mes** | $0 | $5-10 | $89+ |
| **Build time** | ~2-5 min | ~30 seg | ~30 seg |
| **Setup** | Zero-config | Plugin WP | Plugin WP |
| **Optimizaciones** | WebP, srcset | WebP, resize | AI, DAM, todo |
| **Para Qamarero** | **EMPEZAR AQUI** | Si build >5 min | No recomendado |

---

## Propuesta: Estrategia Hibrida e Incremental

### Principio Rector

**"Empezar simple, migrar solo si necesario"**

```
FASE 1 (POC):
├── Astro nativo para TODO
├── Costo: $0/mes
├── Medir build time real
└── Decision basada en datos

FASE 2 (Si build >5 min):
├── Migrar SOLO imagenes dinamicas a Cloudflare
├── Estaticas siguen en Astro
├── Costo: $5-10/mes
└── Build time: ~30 seg

FASE 3 (Solo si necesario):
├── Cloudinary para features avanzadas
├── Costo: $89/mes
├── Poco probable necesario
└── Solo si AI transforms requeridos
```

### Arquitectura FASE 1 (POC)

```
Imagenes estaticas:
├── Ubicacion: src/assets/images/
├── Proceso: Astro Sharp en build
├── Output: WebP optimizado
└── Cache: ./node_modules/.astro/

Imagenes dinamicas:
├── Ubicacion: WordPress Media Library
├── Fetch: GraphQL (sourceUrl, width, height)
├── Proceso: Astro Sharp via remotePatterns
├── Output: WebP optimizado
└── ISR: Regenera con post

Build:
├── npm run build
├── Sharp procesa imagenes (cacheadas)
├── Tiempo: ~2-5 min (con cache ~2 min)
└── Output: dist/ con imagenes optimizadas
```

---

## Criterios Go/No-Go

### Criterios de Exito

- [ ] **Estaticas:** WebP generado automaticamente
- [ ] **WordPress:** remotePatterns funciona sin warnings
- [ ] **Build time:** <5 min con cache
- [ ] **PageSpeed:** Sin warnings de imagenes
- [ ] **Lazy loading:** Funciona correctamente
- [ ] **LCP:** <2.5s

### Decision Gate

```
Build time con cache?
│
├── <5 min → ✅ APROBAR Astro nativo ($0/mes)
│             └── Continuar FASE 1
│
└── >5 min → ⚠️ EVALUAR Cloudflare Images
              ├── Setup plugin WordPress
              ├── Migrar imagenes dinamicas
              └── Re-medir build time
```

---

## Referencias

- **Astro Image:** https://docs.astro.build/en/guides/images/
- **Astro Remote Images:** https://docs.astro.build/en/guides/images/#remote-images
- **Cloudflare Images:** https://developers.cloudflare.com/images/
- **3.2:** [3.2-Estrategia-Rendering.md](./3.2-Estrategia-Rendering.md)

---

**Preparado por:** Miguel Ortiz Peralta
**Fecha:** 3 Febrero 2026
**Version:** 1.0
**Estado:** Pendiente de validar en POC
