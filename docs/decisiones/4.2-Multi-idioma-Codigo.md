# 4.2 - Â¿CÃ³mo gestionar multi-idioma en cÃ³digo?

## ğŸ“‹ Contexto

**PosiciÃ³n en Ã¡rbol:** NIVEL 4.2 - Multi-idioma
**Depende de:** 1.1 (Haber decidido hardcodear pÃ¡ginas corporativas)
**Afecta a:** Estructura del proyecto, navegaciÃ³n, SEO, workflows de ediciÃ³n, escalabilidad

**Requisitos Qamarero:**
- 4 idiomas: ES (principal), FR, EN, IT
- URLs con subfolders: qamarero.com/fr, qamarero.com/en
- **URLs localizadas por idioma:** /precios (ES), /fr/tarifs (FR), /en/pricing (EN)
- Independencia: Cambios en ES NO afectan FR
- Performance: PageSpeed 95+

**Por quÃ© es importante:**
- Define experiencia de usuario (navegaciÃ³n fluida entre idiomas)
- Impacta SEO internacional (hreflang correctos = mejor ranking)
- Determina la independencia entre idiomas
- Afecta las URLs y la escalabilidad

---

## ğŸ“Š DecisiÃ³n 4.2.1: Â¿CÃ³mo estructuramos el contenido multi-idioma?

### OpciÃ³n A: Archivos separados por idioma â­ ELEGIDA

**Estructura:**
```
src/pages/
â”œâ”€â”€ index.astro          # ES (espaÃ±ol, raÃ­z)
â”œâ”€â”€ precios.astro        # ES â†’ /precios
â”œâ”€â”€ funcionalidades.astro # ES â†’ /funcionalidades
â”œâ”€â”€ fr/
â”‚   â”œâ”€â”€ index.astro      # FR â†’ /fr/
â”‚   â”œâ”€â”€ tarifs.astro     # FR â†’ /fr/tarifs
â”‚   â””â”€â”€ fonctionnalites.astro
â”œâ”€â”€ en/
â”‚   â”œâ”€â”€ index.astro      # EN â†’ /en/
â”‚   â””â”€â”€ pricing.astro    # EN â†’ /en/pricing
â””â”€â”€ it/
    â””â”€â”€ index.astro      # IT â†’ /it/
```

**CÃ³mo funciona:**
- Cada idioma tiene sus propios archivos `.astro` con contenido hardcodeado
- URLs automÃ¡ticas segÃºn nombre de archivo y carpeta
- Componentes visuales compartidos (`<Hero>`, `<Features>`), contenido diferente por idioma

**Pros:**
- âœ… **Independencia 100%:** Cambiar Home ES NO afecta Home FR
- âœ… **Contenido divergente:** FR puede tener 3 features, ES puede tener 5
- âœ… **URLs nativas:** Sin config, Astro genera rutas automÃ¡ticamente
- âœ… **Git diff claro:** Ver cambios por idioma es fÃ¡cil
- âœ… **Performance mÃ¡ximo:** SSG puro, sin overhead de librerÃ­as i18n

**Contras:**
- âš ï¸ **MÃºltiples archivos:** 10 pÃ¡ginas x 4 idiomas = 40 archivos (manejable)
- âš ï¸ **Cambios de diseÃ±o:** Tocar mÃºltiples archivos (mitigado con componentes)

### OpciÃ³n B: Archivos centralizados (TOML/JSON)

**CÃ³mo funciona:** Un solo template por pÃ¡gina, contenido en archivos TOML/JSON

**âŒ NO aplica a Qamarero:**
- Estructura acoplada (todos idiomas deben tener mismos campos)
- Necesitamos independencia total entre idiomas

### OpciÃ³n C: LibrerÃ­a i18n (astro-i18n)

**CÃ³mo funciona:** Usar funciÃ³n `t('key')` para traducir textos

**âŒ NO aplica:**
- Web corporativa estÃ¡tica, no necesita traducciones dinÃ¡micas
- Overhead runtime innecesario

---

### Matriz de Escalabilidad

| PÃ¡ginas | x 4 idiomas | Archivos | RecomendaciÃ³n |
|---------|-------------|----------|---------------|
| **<20** | x4 | <80 | âœ… Archivos separados |
| **20-50** | x4 | 80-200 | âš ï¸ Evaluar hÃ­brido |
| **>50** | x4 | >200 | Content Collections |

**Qamarero tiene ~10-15 pÃ¡ginas corporativas â†’ Archivos separados âœ…**

---

### Escenario: Archivos DIFERENTES por idioma

**Pregunta:** Â¿QuÃ© pasa si FR tiene pÃ¡ginas que ES no tiene?

**Respuesta: Archivos separados lo soporta PERFECTAMENTE**

```
src/pages/
â”œâ”€â”€ precios.astro            # ES
â”œâ”€â”€ casos-exito.astro        # ES: Solo EspaÃ±a âœ…
â”œâ”€â”€ fr/
â”‚   â”œâ”€â”€ tarifs.astro         # FR
â”‚   â”œâ”€â”€ loi-egalim.astro     # FR: Ley Egalim (solo FR) âœ…
â”‚   â””â”€â”€ mentions-legales.astro
â”œâ”€â”€ en/
â”‚   â”œâ”€â”€ pricing.astro        # EN (menos pÃ¡ginas, OK)
â””â”€â”€ it/
    â””â”€â”€ index.astro          # IT: Solo home por ahora
```

**Por quÃ© funciona:**
- âœ… FR tiene pÃ¡gina exclusiva (`loi-egalim.astro`)
- âœ… ES tiene pÃ¡gina exclusiva (`casos-exito.astro`)
- âœ… EN tiene menos pÃ¡ginas - Rollout gradual OK
- âœ… IT empieza con 1 pÃ¡gina - Escalable cuando quieran

---

### Escenario: Crear pÃ¡gina SOLO en un idioma

**Ejemplo:** Crear `/casos-exito` solo en EspaÃ±a

**Paso 1: Crear el archivo**
```
src/pages/
â”œâ”€â”€ casos-exito.astro    # âœ… Solo creas este
â”œâ”€â”€ fr/
â”‚   â””â”€â”€ (no creas nada)  # No existe en FR
â”œâ”€â”€ en/
â”‚   â””â”€â”€ (no creas nada)  # No existe en EN
â””â”€â”€ it/
    â””â”€â”€ (no creas nada)  # No existe en IT
```

**Paso 2: AÃ±adir al mapa (solo ES)**
```typescript
// src/config/i18n-routes.ts
export const pageEquivalents = {
  // ... otras pÃ¡ginas
  'case-studies': {
    es: 'casos-exito',    // âœ… Solo existe en ES
    // fr: undefined      // No aÃ±ades FR
    // en: undefined      // No aÃ±ades EN
  }
};
```

**Paso 3: Resultado automÃ¡tico**
```
URL /casos-exito funciona âœ…
Selector muestra todos los idiomas âœ…
Clic en FR â†’ /fr/ (home francÃ©s) âœ…
hreflang solo genera ES + x-default âœ…
```

**Paso 4: Cuando quieras aÃ±adir FR**
```
1. Crear: src/pages/fr/etudes-de-cas.astro
2. Actualizar mapa: fr: 'etudes-de-cas'
3. AutomÃ¡tico: selector y hreflang se actualizan
```

---

### Comportamiento del selector en pÃ¡ginas exclusivas

**Problema:** Â¿QuÃ© pasa con el selector de idioma si estoy en una pÃ¡gina que solo existe en ES?

**Opciones:**

| OpciÃ³n | Comportamiento | Pros | Contras |
|--------|---------------|------|---------|
| **A: Ocultar idiomas** | Solo mostrar ES | Limpio | Usuario "atrapado" |
| **B: Fallback a Home** â­ | Mostrar todos â†’ redirige a home del idioma | Usuario siempre puede cambiar | Ligeramente mÃ¡s cÃ³digo |

**RecomendaciÃ³n: OpciÃ³n B (Fallback a Home)**

```
PÃ¡gina /casos-exito (solo ES):
â”œâ”€â”€ Selector visible: ğŸ‡ªğŸ‡¸ ğŸ‡«ğŸ‡· ğŸ‡¬ğŸ‡§ ğŸ‡®ğŸ‡¹
â”œâ”€â”€ ğŸ‡ªğŸ‡¸ ES â†’ /casos-exito (pÃ¡gina actual)
â”œâ”€â”€ ğŸ‡«ğŸ‡· FR â†’ /fr/ (home FR, porque pÃ¡gina no existe)
â”œâ”€â”€ ğŸ‡¬ğŸ‡§ EN â†’ /en/ (home EN)
â””â”€â”€ ğŸ‡®ğŸ‡¹ IT â†’ /it/ (home IT)
```

**Por quÃ© OpciÃ³n B:**
- âœ… **Consistencia visual:** Selector siempre estÃ¡ en el mismo sitio
- âœ… **Usuario no queda atrapado:** Siempre puede navegar a otro idioma
- âœ… **Expectativa cumplida:** Usuario espera poder cambiar de idioma desde cualquier pÃ¡gina

**hreflang en pÃ¡ginas exclusivas:**
```html
<!-- /casos-exito (solo existe en ES) -->
<link rel="alternate" hreflang="es" href="https://qamarero.com/casos-exito" />
<link rel="alternate" hreflang="x-default" href="https://qamarero.com/casos-exito" />
<!-- NO genera hreflang para FR/EN/IT porque no existe pÃ¡gina equivalente -->
```

---

### Propuesta: âœ… OpciÃ³n A - Archivos separados

**Por quÃ© para Qamarero:**
- Independencia 100% (FR puede divergir de ES)
- Pocas pÃ¡ginas (<20 corporativas)
- Contenido diferente por paÃ­s (legal, casos locales)
- Performance mÃ¡ximo (SSG puro, PageSpeed 95-100)
- Caso validado: Cabify, Vercel, Stripe usan mismo approach

**Umbral de re-evaluaciÃ³n:**
- Reconsiderar si pÃ¡ginas crecen a >50
- Por ahora: <20 pÃ¡ginas â†’ Archivos separados PERFECTO âœ…

---

## ğŸ“Š DecisiÃ³n 4.2.2: Â¿CÃ³mo navegamos entre idiomas?

### âœ… Selector manual en Header

**CÃ³mo funciona:**
- Usuario ve dropdown con banderas (ğŸ‡ªğŸ‡¸ ğŸ‡«ğŸ‡· ğŸ‡¬ğŸ‡§ ğŸ‡®ğŸ‡¹) en Header
- Clic en bandera â†’ redirige a misma pÃ¡gina en otro idioma
- Mantiene contexto: /precios (ES) â†’ /fr/tarifs (FR)

**Flujo:**
```
Usuario en: qamarero.com/precios (ES)
    â†“
Clica bandera ğŸ‡«ğŸ‡·
    â†“
Redirige a: qamarero.com/fr/tarifs (FR)
    â†“
Contexto mantenido âœ…
```

**Por quÃ©:**
- âœ… Usuario controla cambio (no sorpresas)
- âœ… Mantiene contexto de navegaciÃ³n
- âœ… SEO friendly (hreflang en cada link)

---

## ğŸ“Š DecisiÃ³n 4.2.3: Â¿CÃ³mo gestionamos SEO multi-idioma?

### âœ… hreflang tags en cada pÃ¡gina

**QuÃ© incluir:**
```html
<!-- Precios ES (qamarero.com/precios) -->
<html lang="es">
<head>
  <link rel="alternate" hreflang="es" href="https://qamarero.com/precios" />
  <link rel="alternate" hreflang="fr" href="https://qamarero.com/fr/tarifs" />
  <link rel="alternate" hreflang="en" href="https://qamarero.com/en/pricing" />
  <link rel="alternate" hreflang="it" href="https://qamarero.com/it/prezzi" />
  <link rel="alternate" hreflang="x-default" href="https://qamarero.com/precios" />
  <link rel="canonical" href="https://qamarero.com/precios" />
</head>
```

**Por quÃ© es necesario:**
- Google entiende que son versiones del mismo contenido
- Evita penalizaciÃ³n por contenido duplicado
- Muestra idioma correcto en SERPs segÃºn ubicaciÃ³n
- `x-default` indica versiÃ³n predeterminada (espaÃ±ol)

---

## ğŸ“Š DecisiÃ³n 4.2.4: Â¿CÃ³mo persistimos la selecciÃ³n de idioma?

### âœ… Cookie (30 dÃ­as)

- Al cambiar idioma, guardar cookie: `preferredLang=fr`
- VÃ¡lida 30 dÃ­as
- GDPR: Cookie tÃ©cnica OK (no necesita consentimiento)

**Por quÃ©:** Balance UX vs complejidad, funciona cross-page, GDPR compliant

---

## ğŸ“Š DecisiÃ³n 4.2.5: Â¿QuÃ© pasa si pÃ¡gina no existe en un idioma?

### âœ… 404 en idioma

- Si `/it/features` no existe â†’ mostrar 404 en italiano: "Pagina non trovata"
- Ofrecer link a versiÃ³n en otro idioma disponible

**Por quÃ©:** Honesto con usuario, simple, Ãºtil durante setup gradual de idiomas

---

## ğŸ“Š DecisiÃ³n 4.2.6: Mapeo entre idiomas (URLs localizadas)

### Problema

**Â¿CÃ³mo sabe el sistema que `/precios` (ES) corresponde a `/fr/tarifs` (FR)?**

Para que el selector de idioma funcione y los hreflang sean correctos, necesitamos mapear pÃ¡ginas equivalentes.

**Requisito SEO:**
Las URLs DEBEN estar localizadas por idioma para SEO Ã³ptimo:
- ES: `/precios` (no `/pricing`)
- FR: `/fr/tarifs` (no `/fr/pricing`)
- EN: `/en/pricing`
- IT: `/it/prezzi`

### âœ… Archivos traducidos + Mapa de equivalencias

**1. Estructura de archivos (nombres traducidos):**
```
src/pages/
â”œâ”€â”€ index.astro              # ES: /
â”œâ”€â”€ precios.astro            # ES: /precios âœ…
â”œâ”€â”€ funcionalidades.astro    # ES: /funcionalidades âœ…
â”œâ”€â”€ casos-exito.astro        # ES: /casos-exito âœ…
â”‚
â”œâ”€â”€ fr/
â”‚   â”œâ”€â”€ index.astro          # FR: /fr/
â”‚   â”œâ”€â”€ tarifs.astro         # FR: /fr/tarifs âœ…
â”‚   â”œâ”€â”€ fonctionnalites.astro # FR: /fr/fonctionnalites âœ…
â”‚   â””â”€â”€ cas-clients.astro    # FR: /fr/cas-clients âœ…
â”‚
â”œâ”€â”€ en/
â”‚   â”œâ”€â”€ index.astro          # EN: /en/
â”‚   â”œâ”€â”€ pricing.astro        # EN: /en/pricing âœ…
â”‚   â”œâ”€â”€ features.astro       # EN: /en/features âœ…
â”‚   â””â”€â”€ case-studies.astro   # EN: /en/case-studies âœ…
â”‚
â””â”€â”€ it/
    â”œâ”€â”€ index.astro          # IT: /it/
    â”œâ”€â”€ prezzi.astro         # IT: /it/prezzi âœ…
    â””â”€â”€ funzionalita.astro   # IT: /it/funzionalita âœ…
```

**2. Mapa centralizado de equivalencias:**
```typescript
// src/config/i18n-routes.ts
type Lang = 'es' | 'fr' | 'en' | 'it';
type PageRoutes = Partial<Record<Lang, string>>; // PÃ¡gina puede existir en algunos idiomas

export const pageEquivalents: Record<string, PageRoutes> = {
  'home': { es: '', fr: '', en: '', it: '' },
  'pricing': { es: 'precios', fr: 'tarifs', en: 'pricing', it: 'prezzi' },
  'features': { es: 'funcionalidades', fr: 'fonctionnalites', en: 'features', it: 'funzionalita' },
  'case-studies': { es: 'casos-exito' },  // Solo ES por ahora
};

// Helper: obtener URL de pÃ¡gina equivalente (con fallback a home)
export function getAlternateUrl(pageKey: string, lang: Lang): string {
  const slug = pageEquivalents[pageKey]?.[lang];
  const prefix = lang === 'es' ? '' : `/${lang}`;

  // Si pÃ¡gina existe en ese idioma â†’ URL de la pÃ¡gina
  if (slug !== undefined) {
    return slug ? `${prefix}/${slug}` : prefix || '/';
  }

  // Si NO existe â†’ Fallback a home de ese idioma
  return prefix || '/';
}

// Helper: verificar si pÃ¡gina existe en un idioma (para hreflang)
export function pageExistsInLang(pageKey: string, lang: Lang): boolean {
  return pageEquivalents[pageKey]?.[lang] !== undefined;
}
```

**3. Selector de idioma (siempre visible, con fallback a home):**
```astro
// src/components/LanguageSelector.astro
---
import { getAlternateUrl, pageExistsInLang } from '../config/i18n-routes';

const { pageKey, currentLang } = Astro.props;
const languages = ['es', 'fr', 'en', 'it'] as const;
---

<nav class="language-selector">
  {languages.map(lang => {
    const url = getAlternateUrl(pageKey, lang);
    const pageExists = pageExistsInLang(pageKey, lang);

    return (
      <a
        href={url}
        class:list={[
          { active: lang === currentLang },
          { 'fallback-home': !pageExists }
        ]}
        hreflang={lang}
        title={pageExists ? undefined : `Ir a inicio ${lang.toUpperCase()}`}
      >
        {lang.toUpperCase()}
      </a>
    );
  })}
</nav>

<style>
  .fallback-home {
    opacity: 0.7; /* Opcional: indicar visualmente que es fallback */
  }
</style>
```

**4. hreflang en BaseLayout (solo idiomas donde pÃ¡gina existe):**
```astro
// src/layouts/BaseLayout.astro
---
import { pageEquivalents, getAlternateUrl, pageExistsInLang } from '../config/i18n-routes';

const { pageKey, lang } = Astro.props;
const baseUrl = 'https://qamarero.com';
const languages = ['es', 'fr', 'en', 'it'] as const;
---

<head>
  <!-- hreflang SOLO para idiomas donde la pÃ¡gina existe -->
  {languages.map(altLang => {
    if (!pageExistsInLang(pageKey, altLang)) return null;
    const url = getAlternateUrl(pageKey, altLang);
    return (
      <link rel="alternate" hreflang={altLang} href={`${baseUrl}${url}`} />
    );
  })}

  <!-- x-default apunta a ES (si existe) o al primer idioma disponible -->
  <link rel="alternate" hreflang="x-default" href={`${baseUrl}${getAlternateUrl(pageKey, 'es')}`} />
</head>
```

**Resultado para pÃ¡gina solo en ES (/casos-exito):**
```html
<link rel="alternate" hreflang="es" href="https://qamarero.com/casos-exito" />
<link rel="alternate" hreflang="x-default" href="https://qamarero.com/casos-exito" />
<!-- NO genera FR, EN, IT porque no existen -->
```

**5. Regla del equipo al crear nueva pÃ¡gina:**
```
1. Crear archivo con nombre traducido:
   - ES: src/pages/nueva-pagina.astro
   - FR: src/pages/fr/nouvelle-page.astro
   - EN: src/pages/en/new-page.astro

2. AÃ±adir entrada en i18n-routes.ts:
   'new-page': {
     es: 'nueva-pagina',
     fr: 'nouvelle-page',
     en: 'new-page',
     it: 'nuova-pagina'
   }

3. Usar pageKey en la pÃ¡gina:
   <BaseLayout pageKey="new-page" lang="es">
```

---

## ğŸ’¡ Resumen de Decisiones

| # | DecisiÃ³n | Propuesta | Por quÃ© |
|---|----------|-----------|---------|
| **4.2.1** | Estructura archivos | Archivos separados | Independencia total, contenido puede divergir |
| **4.2.2** | NavegaciÃ³n idiomas | Selector manual (Header) | Control usuario, mantiene contexto |
| **4.2.3** | SEO multi-idioma | hreflang tags | Google entiende versiones |
| **4.2.4** | Persistencia idioma | Cookie (30 dÃ­as) | Balance UX vs complejidad |
| **4.2.5** | PÃ¡ginas faltantes | 404 en idioma | Honesto durante setup |
| **4.2.6** | Mapeo entre idiomas | Archivos traducidos + Mapa | URLs localizadas, SEO Ã³ptimo |

**Stack tÃ©cnico resultante:**
```
Estructura:
â””â”€ src/pages/[lang]/slug-traducido.astro

URLs localizadas:
â”œâ”€ ES: /precios, /funcionalidades, /casos-exito
â”œâ”€ FR: /fr/tarifs, /fr/fonctionnalites, /fr/cas-clients
â”œâ”€ EN: /en/pricing, /en/features, /en/case-studies
â””â”€ IT: /it/prezzi, /it/funzionalita, /it/casi-studio

NavegaciÃ³n:
â””â”€ Header con LanguageSelector (usa mapa de equivalencias)

SEO:
â””â”€ BaseLayout con hreflang tags (generados desde mapa)

Persistencia:
â””â”€ Cookie preferredLang (30 dÃ­as)

Mapeo:
â””â”€ src/config/i18n-routes.ts (mapa centralizado)
```

---

## ğŸ§ª ValidaciÃ³n en POC

### Criterios de Ã‰xito

**Estructura:**
- [ ] **Independencia:** Cambiar hero.title ES â†’ FR NO se ve afectado
- [ ] **Performance:** PageSpeed >95 en TODOS los idiomas
- [ ] **Escalabilidad:** Copiar carpeta FR â†’ IT en <30 min
- [ ] **Build time:** <5 min con 4 idiomas x 10 pÃ¡ginas

**NavegaciÃ³n:**
- [ ] **Selector visible:** Dropdown con banderas en Header funciona
- [ ] **Contexto mantenido:** /precios (ES) â†’ clic FR â†’ /fr/tarifs (FR)
- [ ] **Cookie persiste:** preferredLang guardada 30 dÃ­as

**SEO:**
- [ ] **URLs localizadas:** /precios (ES), /fr/tarifs (FR), /en/pricing (EN)
- [ ] **hreflang tags:** Presentes con URLs correctas traducidas
- [ ] **Canonical URLs:** Correctos
- [ ] **Google Search Console:** 0 errores en hreflang report

**Mapeo:**
- [ ] **Mapa funciona:** i18n-routes.ts contiene todas las equivalencias
- [ ] **Selector usa mapa:** Redirige a URL traducida correcta
- [ ] **hreflang usa mapa:** Tags generan URLs localizadas

### Tests Clave

**1. Test independencia**
- Cambiar `hero.title` en Home ES
- Verificar que Home FR NO se ve afectado

**2. Test navegaciÃ³n con URLs traducidas**
- Usuario en /precios (ES) â†’ Clic FR â†’ /fr/tarifs (FR)
- NO debe ir a /fr/ (home)

**3. Test SEO**
- Build pÃ¡gina Precios ES
- Verificar hreflang tags apuntan a URLs traducidas

**4. Test mapeo**
- AÃ±adir nueva pÃ¡gina en i18n-routes.ts
- Verificar selector genera URL correcta

**5. Test pÃ¡gina exclusiva de un idioma**
- Crear `/casos-exito` solo en ES (sin FR, EN, IT)
- Verificar selector muestra todos los idiomas
- Verificar clic en FR â†’ /fr/ (home, fallback correcto)
- Verificar hreflang solo genera ES + x-default
- Verificar NO genera hreflang para FR, EN, IT

---

## âœ… DecisiÃ³n Final

**Si TODOS los criterios âœ…:**
- Aprobar sistema multi-idioma
- Pasar a **NIVEL 4.3** (SegregaciÃ³n permisos)

**Si algÃºn criterio âŒ:**
- Iterar sobre problema especÃ­fico

---

## ğŸ“š Referencias

- **ADR-009:** URLs Multi-idioma con Subfolders
- **1.1:** [CMS vs Hardcoded](./1.1-CMS-vs-Hardcoded.md)
- **Caso real:** Cabify usa archivos separados, funciona genial
- **ValidaciÃ³n:** Vercel, Stripe, Linear usan mismo approach

---

**Preparado por:** Miguel Ortiz Peralta
**Fecha:** 3 Febrero 2026
**VersiÃ³n:** 4.2
**Estado:** â³ Pendiente de validaciÃ³n en POC
